## 文学作品分析网站用户权限与字数限制

### 1. 未登录用户（游客）

- 未登录单次上限字数：5000字
- 未登录每日累计上限字数：100000字

### 2. 登录用户（普通用户）

- 登录单次上限字数：60000字
- 登录每日累计上限字数：无

### 3. 会员用户

- 会员单次上限字数：无
- 会员每日累计上限字数：无
- 会员高级模型调用次数分为**捐赠赠送**和**付费购买**两种类型，并根据**累计消费总额**享受不同优惠。

---

## 会员高级模型调用次数计算方案（最终优化版：平衡赠送与付费）

### 高级大模型单次调用基础成本估算（含利润与运营）

单次高级模型调用的**基础单位成本设定为：人民币 0.50 元**。此价格是付费购买的基准价格，已包含原始模型成本、运营费用分摊及合理利润。

### 累计消费总额与会员等级/优惠

根据用户**累计消费总额**（包括捐赠和付费）来确定其会员等级和享受的折扣。**累计消费达到460元即可享受最高优惠。**

| 累计消费总额 (C)   | 会员等级/折扣等级 | 付费调用折扣 |
| :----------------- | :---------------- | :----------- |
| `C < 50 元`        | 普通会员          | `0%`         |
| `50 ≤ C < 150 元`  | 铜牌会员          | `5%`         |
| `150 ≤ C < 300 元` | 银牌会员          | `10%`        |
| `300 ≤ C < 460 元` | 金牌会员          | `15%`        |
| `C ≥ 460 元`       | 钻石会员          | `20%`        |

**说明：**

- `累计消费总额 (C)`：指用户在平台上的**历史总捐赠和总付费金额**。
- **付费调用折扣：** 影响用户付费购买调用次数时的单价。

### 1. 捐赠赠送调用次数（每月刷新，月末清零，加法保底，更低保底）

此部分调用次数是用户捐赠行为的额外回馈。采用“加法”保底机制，并设置**更高的虚拟单价**和**更低的保底次数**，以更好地平衡激励与成本，并引导付费。

**新用户福利：** 注册即送 20 次调用次数，这个次数**不计入**赠送调用次数计算，且不刷新。

**赠送调用虚拟单价：** 人民币 **1.20 元/次**。

**每月赠送保底次数：** **5 次**。

**每月赠送上限：** **60 次**。

**每月赠送调用次数计算公式：**

```
每月赠送调用次数 = min( (每月赠送保底次数 + floor( 累计消费总额 (C) / 赠送调用虚拟单价 ) ), 每月赠送上限 )
```

其中：

- `累计消费总额 (C)`：指用户在平台上的**历史总捐赠和总付费金额**。
- `赠送调用虚拟单价`：人民币 1.20 元。
- `每月赠送保底次数`：10 次。
- `每月赠送上限`：80 次。
- `floor()` 函数：向下取整。
- `min()` 函数：取计算结果和上限中的较小值。

**特性：**

- **试用福利：** 10次保底足以让用户体验高级功能，但不足以完全满足长期需求，引导其考虑付费。
- **更高单价：** 通过捐赠获取次数的成本更高，凸显付费的性价比。
- **每月上限：** 严格控制赠送总量。
- **月末清零：** 保持赠送的短期激励性质。

**计算示例：**

- **示例 1：** 用户当月捐赠 `C = 0 元`
  `计算结果 = (10 + floor( 0 / 1.20 ) ) = 10 + 0 = 10` 次
  `每月赠送调用次数 = min( 10, 80 ) = 10` 次。
- **示例 2：** 用户当月捐赠 `C = 20 元`
  `计算结果 = (10 + floor( 20 / 1.20 ) ) = 10 + 16 = 26` 次
  `每月赠送调用次数 = min( 26, 80 ) = 26` 次。
- **示例 3：** 用户当月捐赠 `C = 50 元`
  `计算结果 = (10 + floor( 50 / 1.20 ) ) = 10 + 41 = 51` 次
  `每月赠送调用次数 = min( 51, 80 ) = 51` 次。
- **示例 4：** 用户当月捐赠 `C = 80 元`
  `计算结果 = (10 + floor( 80 / 1.20 ) ) = 10 + 66 = 76` 次
  `每月赠送调用次数 = min( 76, 80 ) = 76` 次。
- **示例 5：** 用户当月捐赠 `C = 100 元`
  `计算结果 = (10 + floor( 100 / 1.20 ) ) = 10 + 83 = 93` 次
  `每月赠送调用次数 = min( 93, 80 ) = 80` 次。

### 2. 付费购买调用次数（永不过期，月末不清零）

此部分是用户直接购买的调用次数，享受累计消费总额带来的折扣，且长期有效。

**付费购买单次调用价格公式：**

```
付费购买单次调用价格 = 基础单位成本 * (1 - 付费调用折扣)
```

**用户购买行为：**
用户可以根据自己的需求，选择购买不同数量的调用次数。例如：

- 购买 100 次
- 购买 500 次

**特性：**

- **单次平价：** 享受累计消费总额带来的折扣，实际单价低于基础单位成本。
- **永不过期：** 购买的次数将永久保留在用户账户中，直至用完。

**计算示例：**
假设用户累计消费总额为 `C = 350 元`（对应金牌会员，付费调用折扣 `15%`）。
`付费购买单次调用价格 = 0.50 * (1 - 0.15) = 0.50 * 0.85 = 0.425 元/次`。
如果用户决定购买 200 次：
`总支付金额 = 200 * 0.425 = 85 元`。
这 200 次调用将添加到用户的“付费调用余额”中，永不过期。

### 在代码中如何实现？

1. 成功并返回结果即为一次成功调用，失败（包括在校验、搜索、分析阶段出现问题）不计入次数。
2. 数据库当中不应该存入除去保存的次数以外的其他内容。
   - 如何处理这一块的信息？
     1. 用户注册完成后应该立刻将赠送写入。
     2. 用户会传入一个爱发电订单号，你需要对其进行查询并获取单笔交易金额。（确保订单号和用户通过oauth绑定的爱发电账户对应）
     3. 通过单笔交易金额，你可以计算出用户应该获得的调用次数。
     4. 将使用过的订单号、使用者使用时间等信息存入数据库，避免重复使用。
     5. 将用户的单笔交易金额和总金额相加替换原来的总金额。
     6. 将计算出的调用次数添加到用户的赠送调用余额中。
3. 敏感信息的处理应该在服务端组件内进行，客户端只进行信息的展示。
4. 后台、文章输入等页面等组件要和当前系统进行绑定。
5. 不要设计太过于耦合的逻辑，尽量解耦。
6. 每个组件输出注释。
7. 一些相关组件：
   - `src/lib/constants.ts` 记录着旧有的计算结构。
   - `src/lib/db.ts` 调用数据库的统一入口。
   - `src/app/dashboard/*` 后台的页面
   - `src/components/layouts/WriterPage/WriterAnalysisInput.tsx` 输入界面需要尤其注意的组件
