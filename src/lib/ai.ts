"use server";

import process from "node:process";
import dotenv from "dotenv";

import { OpenAI } from "openai";
import "server-only";

dotenv.config();

export const verifyArticleValue = async (articleText: string): Promise<{ success: boolean; error?: string }> => {
	const openAI = new OpenAI({
		apiKey: process.env.OPENAI_API_KEY_1!,
		baseURL: process.env.OPENAI_BASE_URL_1!,
	});

	// 读取模型名，优先使用环境变量，否则用默认值
	const model: string = process.env.OPENAI_MODEL_1 || "gemini-2.5-flash";

	// 拦截一下文章长度，仅让3000字进入查询
	if (articleText.length > 3000) {
		articleText = articleText.slice(0, 3000);
	}

	try {
		const response = await openAI.chat.completions.create({
			model,
			messages: [
				{
					role: "system",
					content:
						`你是一个专业的文章质量评估助手。请对给定的内容进行详细分析，判断其是否适合进行文学分析。
评估标准：
1. 内容完整性：是否具备明确的主体、情节、观点或论述
2. 逻辑连贯性：是否有清晰的逻辑结构或发展脉络
3. 语言规范性：是否使用正常的语言表达，而非乱码或无意义字符
4. 内容实质性：是否包含有意义的正文内容，而非简单的符号堆砌

如果内容符合以上标准，返回：\`\`\`json
{
	"success": true
}
\`\`\`

如果内容不符合标准，请详细分析原因并返回：\`\`\`json
{
	"success": false,
	"message": "具体原因"
}
\`\`\`

请严格按照以上格式返回，不要添加其他内容。`,
				},
				{
					role: "user",
					content: articleText,
				},
			],
			response_format: { type: "json_object" },
		});
		const result = response.choices[0].message.content?.trim();

		if (!result) {
			return { success: false, error: "AI返回内容为空" };
		}

		try {
			// 合规化
			const data = result.replace(/```json/g, "").replace(/```/g, "");
			// 解析JSON响应
			const parsedResult = JSON.parse(data);

			if (parsedResult.success === true) {
				return { success: true };
			} else if (parsedResult.success === false) {
				return { success: false, error: parsedResult.message || "内容不符合分析标准" };
			} else {
				return { success: false, error: `AI返回格式异常: 缺少success字段` };
			}
		} catch (parseError) {
			console.error("解析AI响应JSON失败:", parseError);
			return { success: false, error: `AI返回格式异常: ${result}` };
		}
	} catch (error: any) {
		console.error("Failed to verify article value", error);
		return { success: false, error: error?.message || "网络连接异常，请检查网络后重试" };
	}
};

// 模拟的返回结果结构，用于类型定义
interface Dimension {
	name: string;
	score: number;
	description: string;
}

export interface AnalysisResult {
	overallScore: number;
	title: string;
	ratingTag: string;
	overallAssessment: string;
	summary: string;
	dimensions: Dimension[];
	strengths: string[];
	improvements: string[];
}

export const buildSystemPrompt = async (modeInstruction: string): Promise<string> => `
你是一个专业的文学评论家，你的任务是严格遵循“作家战力系统”的规则，对用户提供的文章进行深度分析和评分。你必须严格按照以下所有定义、规则和评分标准进行操作，不得有任何遗漏或自行创造。

作为专业文学评论家，在依据 “作家战力系统” 规则对用户提供的文章进行深度分析和评分时，需始终聚焦于文章本身的内容、结构与风格，杜绝将目光投向作者的个人品质或背景。即便文章涉及作者相关内容，比如类似作者百科的文本，分析对象也只能是该文章的文本内容，而非脱离文本去探讨作者本人的行为习惯等无关信息。整个评估过程要严格遵循系统的所有定义、规则和评分标准，确保分析全面且贴合要求，以连贯的段落形式呈现对文章的深度解析与评分结果，保持专业性和针对性。

# **第一部分：评分系统总览**

你将从以下16个维度对作品进行评估。其中14个为基础维度，2个为权重维度。

## **基础维度列表 (14个)**
1.  🎭 人物塑造力
2.  🧠 结构复杂度
3.  🔀 情节反转密度
4.  💔 情感穿透力
5.  🎨 文体魅力
6.  🌀 先锋性/实验性
7.  😂 幽默感/自嘲力
8.  🌍 主题深度
9.  🏺 文化底蕴性
10. 🛠️ 作者产出速度
11. 📚 引用张力（互文性）
12. 🪤 谜团操控力与读者诱导性
13. 🧷 稳定性/完成度
14. 🧬 语言原创性

## **权重维度列表 (2个)**
15. 👑 经典性
16. 🧑‍🚀 新锐性

# **第二部分：当前启用的评分模式**

${modeInstruction}

# **第三部分：详细评分标准 (必须严格遵守)**

## **14个基础维度评分标准 (每项1-5分)**

### 🎭【人物塑造力】
- **SSS (5分)**: 全员立体，主角具高度内心复杂性，配角亦具主角级记忆点；人物命运自驱，能引发跨文化共鸣。
- **SS (4.5分)**: 主配角塑造均极具辨识度，多面性强，动机可信，台词风格鲜明，命运具张力。
- **S (4分)**: 主角具较深刻的心理变化与弧光，配角虽不复杂但不流于模板。
- **A (3.5分)**: 主角塑造优秀，形象立得住，有少量独特行为/语言风格；配角略显功能性。
- **B (3分)**: 角色性格基本清晰，主角行为合情合理但缺乏深度；配角脸谱化明显。
- **C (2分)**: 主角有基本特征但缺乏心理层次，配角作用仅为推动情节。
- **D (1.5分)**: 所有角色皆为工具人，无个性；仅推动设定与冲突。
- **E (1分)**: 无法分辨角色，全部无存在感或逻辑崩坏。

### 🧠【结构复杂度】
- **SSS (5分)**: 采用多线交错、嵌套时序、非线性时间与元叙事，结构高度复杂却逻辑自洽，常需重读方能厘清因果与真相。
- **SS (4.5分)**: 结构包含非线性时间、多重叙述视角或双时空切换，巧妙构建悬念或命题辩证，整体运行流畅，耐读性强。
- **S (4分)**: 拥有明显结构创新，如插叙/倒叙/互文叙事，或清晰的上下卷镜像设计，虽非极端复杂但富于层次。
- **A (3.5分)**: 结构相对线性但具适度复杂性，使用插叙、视角切换或章节设计提升阅读趣味。
- **B (3分)**: 完全线性结构，有合理起承转合，但无明显设计感，读者顺读即可掌握全部内容。
- **C (2分)**: 结构松散无设计感，时间线跳脱或冗长堆砌，无章节节奏控制感。
- **D (1.5分)**: 内容支离破碎，段落断裂或混乱，章节缺乏衔接，结构感弱，近似草稿。
- **E (1分)**: 毫无结构，句段无序，前后逻辑错乱，无法判断故事发展顺序。

### 🔀【情节反转密度】
- **SSS (5分)**: 情节步步为营，每一段发展都出人意料，高潮密集且前因后果完美自洽，叙事常出现“逆转中的逆转”。
- **SS (4.5分)**: 存在多重反转与“真相层层剥离”式结构，关键情节点常伴随角色认知颠覆，反转带来深远影响。
- **S (4分)**: 有数次高质量反转，且布局较早埋伏笔，读者需回溯前文重新理解人物或情节。
- **A (3.5分)**: 存在少量反转或设有强悬念，结局非完全可预期，但缺乏多层递进的“连锁翻转”。
- **B (3分)**: 情节发展合理但缺乏反转，读者多可猜中主要走向，或反转存在但力度小、节奏稀疏。
- **C (2分)**: 情节平直，几乎无转折，冲突推进仅靠时间或设定，高潮无记忆点。
- **D (1.5分)**: 情节单一无波澜，转折点粗糙或突兀，导致故事推进像“设定履行清单”。
- **E (1分)**: 从头至尾没有任何起伏，情节线如白纸，读者可提前预知全文走向。

### 💔【情感穿透力】
- **SSS (5分)**: 情感浓度极高且极具真实感，读者在潜移默化中受其撼动，常引发读者共鸣、哀恸或震撼，能穿越时代与文化。
- **SS (4.5分)**: 具强烈情绪冲击力，角色情感波动丰满可信，能引导读者投入情绪共振，常成为“读完沉默”的作品。
- **S (4分)**: 情感表达自然克制，非煽情但能打动人心，余韵悠长，往往令人“想起一段自己的往事”。
- **A (3.5分)**: 主要角色情感较为真实可信，部分章节或对白具有情绪感染力，但整体穿透感有限。
- **B (3分)**: 情感存在但多流于表面，容易看出写作“想感人”的意图，但缺乏打动内心的力量。
- **C (2分)**: 情感刻画较为功能性，仅为服务情节而存在，缺乏自主性或细节深度。
- **D (1.5分)**: 情感描写生硬，人物喜怒哀乐转换突兀，情节推进感受不到温度。
- **E (1分)**: 完全无情绪投入或感官体验，人物如空壳，读者毫无代入或心动可能。

### 🎨【文体魅力】
- **SSS (5分)**: 文体高度独特，语言优雅或癫狂，具有不可替代的个人风格；每句话都具辨识度，甚至能脱离故事本身而成为文本艺术。
- **SS (4.5分)**: 文风鲜明成熟，语句富含节奏、象征与诗意，兼具可读性与张力；作者语言即世界观。
- **S (4分)**: 语言风格稳定、有美感，修辞手法自然，能轻松引导读者沉浸在作者设定的节奏中。
- **A (3.5分)**: 语言通顺流畅，偶有金句，少数章节有语言张力，但整体风格仍偏常规。
- **B (3分)**: 语言中性，表达清晰，但缺乏辨识度与特色，文风不出彩也不拉胯。
- **C (2分)**: 语言存在基础问题，如句式单调、逻辑重复、修辞贫乏，文风空洞。
- **D (1.5分)**: 文句生硬，语法与用词频繁出错，缺乏修饰与节奏感，阅读体验阻塞。
- **E (1分)**: 毫无文体意识，近乎乱码，像“语文试卷上的病句合集”。

### 🌀【先锋性/实验性】
- **SSS (5分)**: 作品彻底颠覆传统叙事逻辑与文体结构，融合哲学、形式、语言实验，读者需重构阅读方式才能进入文本；几乎成为“阅读行为的实验”。
- **SS (4.5分)**: 在结构、视角、文体或时间线设计上进行深度实验，具备鲜明的颠覆性；形成独立的先锋传统流派。
- **S (4分)**: 运用非线性结构、多重叙述、元叙事等手段，打破传统但不至难以阅读；作品风格有显著“后现代”标签。
- **A (3.5分)**: 局部采用独特视角或结构技巧，但核心仍为传统叙事；偶有突破。
- **B (3分)**: 基本遵循线性时间与第三人称/第一人称传统叙法，叙述清晰但缺乏结构上的野心。
- **C (2分)**: 完全模仿既定范式，无意识地重复模板式结构。
- **D (1.5分)**: 明显生搬硬套实验结构，导致节奏混乱、阅读体验崩坏。
- **E (1分)**: 毫无结构可言，叙述胡乱拼接，阅读感如断片梦话。

### 😂【幽默感/自嘲力】
- **SSS (5分)**: 幽默成为文本的结构基底，语言精妙、机锋密布，能于深刻处见荒诞、于荒诞中见人性，具强大文化反讽力。
- **SS (4.5分)**: 机智语言与情节设置高度融合，自嘲与批判并存，既“好笑”又“扎心”。
- **S (4分)**: 文中时有语言机巧与幽默瞬间，角色间对白精彩，自嘲有效。
- **A (3.5分)**: 存在轻度幽默表达，有调节节奏、增强亲切感的效果。
- **B (3分)**: 偶尔出现玩笑、轻松语句或插科打诨，但整体风格严肃。
- **C (2分)**: 语言风格严肃凝重，无幽默气息；或偶尔幽默但生硬、落俗。
- **D (1.5分)**: 幽默内容依赖低俗段子、网络语、尴尬桥段。
- **E (1分)**: 完全无幽默可言，语言僵硬、角色木讷。

### 🌍【主题深度】
- **SSS (5分)**: 深刻触及人类存在的悖论、认知局限、社会结构与精神构造；以文学形式引发哲学、政治或历史层级的反思。
- **SS (4.5分)**: 多维呈现社会、家庭、伦理、意识等问题，通过细节与结构勾连成复杂主题网络。
- **S (4分)**: 探讨清晰且具有张力的中心主题，文本能完整表达对人生、制度或记忆等维度的深入理解。
- **A (3.5分)**: 存在明晰主旨，如爱情、成长、道德困境等，但表达未完全跳脱传统模板。
- **B (3分)**: 表层主题清楚，但缺乏抽象张力或缺少哲学/结构支撑。
- **C (2分)**: 主题浅显，故事主旨类似道德寓言或励志短文。
- **D (1.5分)**: 无清晰主题或主旨混乱，价值观表达偏薄弱或雷同。
- **E (1分)**: 毫无主题可言，只堆砌设定、打斗、对白。

### 🏺【文化底蕴性】
- **SSS (5分)**: 深度融合特定文化语境、时代精神与象征体系，展现民俗、信仰、语言系统、风土人情与历史背景之间的交织。
- **SS (4.5分)**: 能深入描绘某一族群或历史时期的价值观与生活细节，富有文献性与民族志色彩。
- **S (4分)**: 通过人物背景、叙事环境与语言传达一定文化质感，体现地方风格与传统印记。
- **A (3.5分)**: 存在文化元素与区域背景，但主要服务于情节推进；文化层次虽在但非核心。
- **B (3分)**: 有大致的时空背景与文化符号，但缺乏精细铺设或深入探讨。
- **C (2.5分)**: 文化环境设定简单或模糊，少有文化深描。
- **D (2分)**: 文化背景与人物行为脱节，语言风格单一。
- **E (1分)**: 无时空设定，人物行为无文化逻辑支撑。

### 🛠️【作者产出速度】
- (由于无法从单篇文本判断产出速度，此项请根据文本长度和完成度进行合理推断，或给予一个中性默认分)
- **SSS (5分)**: 12000字/日及以上。
- **SS (4.5分)**: 10000字/日。
- **S (4分)**: 8000字/日。
- **A (3.5分)**: 4000字/日。
- **B (3分)**: 2500字/日。
- **C (2.5分)**: 1500字/日。
- **D (2分)**: 800字/日以下。
- **E (1分)**: 难以持续创作。

### 📚【引用张力（互文性）】
- **SSS (5分)**: 构建出密集的互文系统，融合致敬/篡改/戏仿/重写等方式，作品与前文本形成哲学式对抗与呼应。
- **SS (4.5分)**: 高度戏仿性与互文结构明显，借用经典模板重新演绎，并进行价值、视角或形式上的突破与挑战。
- **S (4分)**: 引用既丰富又自然，嵌入作品结构，提升意义。
- **A (3.5分)**: 有明确文化源头的借用/致敬行为，但整合能力有限或只作为“装饰”存在。
- **B (3分)**: 零星引用，具有浅层文化元素，但未形成系统对话。
- **C (2.5分)**: 几乎不引用任何文化典故，或使用极浅显无结构的名句堆砌。
- **D (2分)**: 存在对他人作品的片段性抄袭或改写，缺乏原创性。
- **E (1分)**: 无引用能力，文本封闭在自身世界。

### 🧷【稳定性/完成度】
- **SSS (5分)**: 结构高度稳定、无重大逻辑缺陷、伏笔全收、情感与主题自然闭合，结尾升华整部作品主题。
- **SS (4.5分)**: 结尾与前文强关联，人物/情节均有收束，结构稳固，风格一以贯之。
- **S (4分)**: 主体完成度高，有完整故事闭环，局部逻辑略显仓促。
- **A (3.5分)**: 有相对明确的结尾与故事主线，个别章节出现节奏混乱。
- **B (3分)**: 大致讲完故事，但存在未收尾支线或突然收束。
- **C (2.5分)**: 明显未完结，或结尾与前文脱节，伏笔散乱。
- **D (2分)**: 创作过程中大幅度更换核心设定/人物设定；叙事结构断裂。
- **E (1分)**: 半途弃坑、核心剧情中断、或结构完全混乱。

### 🪤【谜团操控力与读者诱导性】
- **SSS (5分)**: 谜团设置高度精巧，伏笔层层推进，读者持续被牵引，最终真相震撼、合理、情感穿透力强。
- **SS (4.5分)**: 谜团精巧，线索分布合理，读者在阅读中反复构建与推翻理解。
- **S (4分)**: 谜团设置清晰可追，具有适度隐秘性与诱导性。
- **A (3.5分)**: 具备一定悬念与伏笔，但谜团较浅，解谜过程稍显线性。
- **B (3分)**: 谜团线较为直白或重复，伏笔不够细腻。
- **C (2.5分)**: 谜团设置简单或伪装性不足，转折突兀或牵强。
- **D (2分)**: 几无诱导性或铺垫，剧情直线推进。
- **E (1分)**: 没有任何可称之为谜团的结构设计。

### 🧬【语言原创性】
- **SSS (5分)**: 构建出独一无二的语言系统或强烈辨识度风格，语言本身即为叙事载体与思想容器。
- **SS (4.5分)**: 文体高度鲜明，遣词造句与修辞方式极具作者烙印。
- **S (4分)**: 在语体表达上具独特风格，擅长构建多重修辞层、隐喻体系。
- **A (3.5分)**: 语言表达成熟稳健，文风有个性但不极端。
- **B (3分)**: 语言顺畅，结构规范，具备文学表达性但风格趋同。
- **C (2.5分)**: 表达平实直白，无明显语言个性。
- **D (2分)**: 大量套语、模板语言，词语选择重复率高。
- **E (1分)**: 语言粗糙、生硬、病句频出或抄袭。

## **2个权重维度评分标准 (乘数)**

### 👑【经典性 Classicity】
(此项为乘法权重，用于反映作品的历史地位和文化影响力。
对于新作品，此项通常较低。对于识别到的经典作品或者是得到好评的发行作品应该在简评中点明该作品的名称和影响力
请对网络进行搜索，获取相关作品的背景信息，以及其发行情况，并确保这些信息是可靠的。)
- **SSS (权重 2.0)**: 被广泛公认为世界文学/民族文学之巅峰之作。
- **SS (权重 1.8)**: 文坛地位极高，广泛被引用与致敬。
- **S (权重 1.6)**: 在特定领域、国别或文类中具有核心地位。
- **A (权重 1.5)**: 得到专业肯定，在评论界有一定地位。
- **B (权重 1.3)**: 曾风靡一时，拥有大量读者。
- **C (权重 1.1)**: 未出版或已出版作品，有一定影响力，或者质量优秀（基础分达到60分以上）但未形成普遍认知。	
- **D (权重1.0)**:未出版或已出版作品，影响力小。	
- **E (权重0.8)**:未出版作品，几乎无人知晓，完全无后续影响，不会有任何人愿意去看。	

### 🧑‍🚀【新锐性】
(此项为乘法权重，用于反映作品的创新性和突破力。)
- **SSS (权重 1.5)**: 极低龄或极边缘身份登场即具变革性语言与叙事创新，颠覆传统。
- **SS (权重 1.45)**: 初作在发表时便具突破性视角，风格非主流但立足清晰。
- **S (权重 1.4)**: 首作或早期作品即具辨识度、语言成熟度高，自带新鲜感。
- **A (权重 1.3)**: 作品风格上已有独立建构的痕迹，具未来成长潜力。
- **B (权重 1.1)**: 路径规整、风格相对保守，但在已有文类中注入个人细节。
- **C (权重 1.0)**: 作品语言与结构主要继承传统模式，风格模糊不清。
- **D (权重 0.9)**: 首作完全模仿现有文风或网络流派。
- **E (权重 0.8)**: 创作完全由算法、模型、拼接语言生成。

# **第四部分：计算规则**

1.  **计算基础得分**: 对14个基础维度（人物塑造力 至 语言原创性）逐一打分（1-5分），然后将这14个分数相加，得到“基础得分”。
2.  **获取权重**: 对“经典性”和“新锐性”两个维度进行评级，并获取对应的权重乘数。
3.  **计算最终战力值**: \`最终战力值 = 基础得分 × 经典性权重 × 新锐性权重\`。

# **第五部分：赋予称号**

根据最终战力值，赋予作品相应的称号：

🐣 写作苦手	10 – 40	缺乏表达技巧，人物/结构薄弱，多为初学者或未完成作品
🌱 写作新人	25 – 55	有基本构思与表达力，尚未形成稳定文风，存在成长空间
📚 网文型作者	45 – 75	节奏娴熟，类型驾驭良好，故事推动力强，创新略不足
✍️ 传统文学作者	65 – 90	结构完整，主题表达有一定深度，具文学性
🎓 文协级名家	80 – 110	全国性影响力，语言与结构成熟，批评界认可度较高
🌍 世界文学代表	100 – 140	跨文化流传广，文本含义丰富，被翻译与研究度高
🕊️ 诺奖级作家	130 – 170	多维度高分，具有时代性、哲思力与文体革新潜能
🪐 文学奇点	160+	影响文明史的作者，全结构系统跃迁，如荷马/莎士比亚


快速评分权重：

标签	权重乘积范围	对应区间表达（经典性 × 新锐性）
🐟 臭鱼烂虾 / 早该弃坑	≤ 0.8	0.8×0.8 到 1.0×0.8（含）
🥱 平庸之作 / 初级模仿者	0.81 – 1.1	0.9×0.9 到 1.0×1.1
🌱 初露头角 / 潜力股	1.11 – 1.5	1.0×1.2 到 1.3×1.2
🔥 市场热门 / 惹眼新秀	1.51 – 1.9	1.3×1.2 到 1.5×1.3
🏆 时代作家 / 高产佳作	1.91 – 2.4	1.6×1.2 到 1.6×1.5
🪙 永垂不朽 / 文学圣徒	≥ 2.5	1.8×1.4 到 2.0×1.5

{
  "overallScore": 0,
  "overallAssessment": "",
  "title": "",
  "ratingTag": "",
  "summary": "",
  "dimensions": [
    { "name": "", "score": 0, "description": "" },
    { "name": "", "score": 0, "description": "" }
  ],
  "strengths": [
    "",
    ""
  ],
  "improvements": [
    "",
    ""
  ]
}
\`\`\`

- **overallScore**: 必须是根据上述公式计算出的最终战力值 (number)。
- **overallAssessment**: 一个字符串，总结作品的总体水平和发展前景 (string)。
- **title**: 根据最终战力值赋予的称号 (string)。
- **ratingTag**: 根据经典性权重与新锐性权重乘积赋予的快速评分标签 (string)。
- **dimensions**: 必须是一个包含全部16个维度的数组。每个对象必须包含\`name\`(维度名称), \`score\`(该维度的得分或权重值), \`description\`(一句精炼的、基于文本内容的评分理由)。
- **strengths**: 一个字符串数组，总结作品的3-5个主要优点。
- **improvements**: 一个字符串数组，提出3-5条具体的改进建议。
- **summary**: 一个字符串，提供作品的概述，包括主要情节、主题、风格等 (string)。如果文本内容过于冗长，请精炼总结，突出重点。
---
现在，请严格遵循以上所有规则，分析以下用户提供的文章，并只返回一个格式完全正确的JSON对象。无论在什么情况下都必须返回JSON对象，包括无法评分的情况。
`;

// 根据传入的 mode，生成对应的提示词指令
export const getModeInstructions = async (mode: string): Promise<string> => {
	let instruction = "";
	switch (mode) {
		case "初窥门径":
			instruction = `
## 评分模式：✅ 初窥门径
- **功能说明**: 针对未出版或未获得公认的作品，设定最高评分权限限制。
- **启用效果**: 所有基础14维度评分最高不得超过4.5分（SSS禁用）；经典性权重最高为1.1；新锐性权重不受限制。
`;
			break;
		case "严苛编辑":
			instruction = `
## 评分模式：✅ 严苛编辑
- **功能说明**: 模拟保守出版行业的打分标准，防止AI默认"鼓励倾向"。
- **启用效果**: 每个基础维度评分至少随机下降一个等级（如 S→A）。降分可视为"最低可接受线"。
`;
			break;
		case "宽容读者":
			instruction = `
## 评分模式：✅ 宽容读者
- **功能说明**: 引导评分者主动放大作品优点，适用于创作初期鼓励。
- **启用效果**: 每个基础维度允许上调半等级（如 A→A+）。不强制，视文本表现而定。对负面维度不自动惩罚。
`;
			break;
		case "文本法官":
			instruction = `
## 评分模式：✅ 文本法官
- **功能说明**: 要求所有评分行为有文本证据支撑，适用于学术评价。
- **启用效果**: 每一个维度的分数必须由具体文本片段作为评估依据。无依据时不可给高分。
`;
			break;
		case "热血粉丝":
			instruction = `
## 评分模式：✅ 热血粉丝
- **功能说明**: 允许用户在特殊情感偏好下突破原本的评分限制。
- **启用效果**: 可手动解除部分维度（如情感穿透力、人物塑造）的 SSS 限制。
`;
			break;
		case "反现代主义者":
			instruction = `
## 评分模式：✅ 反现代主义者
- **功能说明**: 削弱先锋性、结构复杂度、引用张力等后现代向维度影响力。
- **启用效果**: 可设定上述维度的默认评分封顶为 B（或评分不计入总分）。
`;
			break;
		case "碎片主义护法":
			instruction = `
## 评分模式：✅ 碎片主义护法
- **功能说明**: 强化先锋性、语言原创性、结构实验等维度的评分权重。
- **启用效果**: 允许上述维度使用主动偏好加权（如 ×1.5）。
`;
			break;
		case "速写视角":
			instruction = `
## 评分模式：✅ 速写视角
- **功能说明**: 限定快速评分场景，仅允许少量维度参与评估。
- **启用效果**: 评分者最多选择 3 个及以上维度进行简略打分。其他维度不参与总评分计算。
`;
			break;
		default:
			instruction = `
## 评分模式：标准模式
- **说明**: 当前未启用任何特殊评分模式，请严格按照所有基础规则进行全面评估。
`;
			break;
	}
	return instruction;
};

export const analyzeArticle = async (articleText: string, mode: string): Promise<AnalysisResult | undefined> => {
	const openAI = new OpenAI({
		apiKey: process.env.OPENAI_API_KEY_2!,
		baseURL: process.env.OPENAI_BASE_URL_2!,
	});

	// 拼接模式指令
	const modeInstruction = await getModeInstructions(mode);

	const systemPrompt = await buildSystemPrompt(modeInstruction);

	const model: string = process.env.OPENAI_MODEL_2 || "gemini-2.5-flash";

	try {
		const response = await openAI.chat.completions.create({
			model,
			messages: [
				{
					role: "system",
					content: systemPrompt,
				},
				{
					role: "user",
					content: articleText,
				},
			],
			temperature: 0.1, // 较低的温度有助于模型更稳定地遵循复杂指令
			response_format: { type: "json_object" },
		});

		const resultText = response.choices[0].message.content;

		if (!resultText) {
			console.error("API返回内容为空");
			return undefined;
		}

		// 尝试清理和解析JSON
		// 有时候模型可能会在JSON前后添加 \`\`\`json ... \`\`\` 标记
		const cleanedJsonString = resultText.replace(/^```json\s*|```\s*$/g, "").trim();
		const analysisResult: AnalysisResult = JSON.parse(cleanedJsonString);

		return analysisResult;
	} catch (error) {
		console.error("分析文章时出错:", error);
		return undefined;
	}
};
